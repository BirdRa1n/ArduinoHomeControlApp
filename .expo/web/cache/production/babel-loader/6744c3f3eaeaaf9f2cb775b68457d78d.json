{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import _toConsumableArray from\"@babel/runtime/helpers/toConsumableArray\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;})),keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}return target;}function _createForOfIteratorHelperLoose(o,allowArrayLike){var it=typeof Symbol!==\"undefined\"&&o[Symbol.iterator]||o[\"@@iterator\"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length===\"number\"){if(it)o=it;var i=0;return function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};};}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o===\"string\")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n===\"Object\"&&o.constructor)n=o.constructor.name;if(n===\"Map\"||n===\"Set\")return Array.from(o);if(n===\"Arguments\"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}import _regeneratorRuntime from\"@babel/runtime/regenerator\";import{CodedError,Platform}from'@unimodules/core';import compareUrls from'compare-urls';import AppState from\"react-native-web/dist/exports/AppState\";import Dimensions from\"react-native-web/dist/exports/Dimensions\";import{WebBrowserResultType}from\"./WebBrowser.types\";var POPUP_WIDTH=500;var POPUP_HEIGHT=650;var popupWindow=null;var listenerMap=new Map();var getHandle=function getHandle(){return'ExpoWebBrowserRedirectHandle';};var getOriginUrlHandle=function getOriginUrlHandle(hash){return\"ExpoWebBrowser_OriginUrl_\"+hash;};var getRedirectUrlHandle=function getRedirectUrlHandle(hash){return\"ExpoWebBrowser_RedirectUrl_\"+hash;};function dismissPopup(){if(!popupWindow){return;}popupWindow.close();if(listenerMap.has(popupWindow)){var _listenerMap$get=listenerMap.get(popupWindow),listener=_listenerMap$get.listener,appStateListener=_listenerMap$get.appStateListener,interval=_listenerMap$get.interval;clearInterval(interval);window.removeEventListener('message',listener);AppState.removeEventListener('change',appStateListener);listenerMap.delete(popupWindow);var handle=window.localStorage.getItem(getHandle());if(handle){window.localStorage.removeItem(getHandle());window.localStorage.removeItem(getOriginUrlHandle(handle));window.localStorage.removeItem(getRedirectUrlHandle(handle));}popupWindow=null;}}export default{get name(){return'ExpoWebBrowser';},openBrowserAsync:function openBrowserAsync(url){var browserParams,_browserParams$window,windowName,windowFeatures,features,_args=arguments;return _regeneratorRuntime.async(function openBrowserAsync$(_context){while(1){switch(_context.prev=_context.next){case 0:browserParams=_args.length>1&&_args[1]!==undefined?_args[1]:{};if(Platform.isDOMAvailable){_context.next=3;break;}return _context.abrupt(\"return\",{type:WebBrowserResultType.CANCEL});case 3:_browserParams$window=browserParams.windowName,windowName=_browserParams$window===void 0?'_blank':_browserParams$window,windowFeatures=browserParams.windowFeatures;features=getPopupFeaturesString(windowFeatures);window.open(url,windowName,features);return _context.abrupt(\"return\",{type:WebBrowserResultType.OPENED});case 7:case\"end\":return _context.stop();}}},null,null,null,Promise);},dismissAuthSession:function dismissAuthSession(){if(!Platform.isDOMAvailable)return;dismissPopup();},maybeCompleteAuthSession:function maybeCompleteAuthSession(_ref){var _window$opener;var skipRedirectCheck=_ref.skipRedirectCheck;if(!Platform.isDOMAvailable){return{type:'failed',message:'Cannot use expo-web-browser in a non-browser environment'};}var handle=window.localStorage.getItem(getHandle());if(!handle){return{type:'failed',message:'No auth session is currently in progress'};}var url=window.location.href;if(skipRedirectCheck!==true){var redirectUrl=window.localStorage.getItem(getRedirectUrlHandle(handle));var currentUrl=window.location.origin+window.location.pathname;if(!compareUrls(redirectUrl,currentUrl)){return{type:'failed',message:\"Current URL \\\"\"+currentUrl+\"\\\" and original redirect URL \\\"\"+redirectUrl+\"\\\" do not match.\"};}}window.localStorage.setItem(getOriginUrlHandle(handle),url);var parent=(_window$opener=window.opener)!=null?_window$opener:window.parent;if(!parent){throw new CodedError('ERR_WEB_BROWSER_REDIRECT',\"The window cannot complete the redirect request because the invoking window doesn't have a reference to it's parent. This can happen if the parent window was reloaded.\");}parent.postMessage({url:url,expoSender:handle},parent.location);return{type:'success',message:\"Attempting to complete auth\"};},openAuthSessionAsync:function openAuthSessionAsync(url,redirectUrl,openOptions){var _redirectUrl,_popupWindow;var state,features;return _regeneratorRuntime.async(function openAuthSessionAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(Platform.isDOMAvailable){_context3.next=2;break;}return _context3.abrupt(\"return\",{type:WebBrowserResultType.CANCEL});case 2:redirectUrl=(_redirectUrl=redirectUrl)!=null?_redirectUrl:getRedirectUrlFromUrlOrGenerate(url);_context3.next=5;return _regeneratorRuntime.awrap(getStateFromUrlOrGenerateAsync(url));case 5:state=_context3.sent;window.localStorage.setItem(getHandle(),state);window.localStorage.setItem(getRedirectUrlHandle(state),redirectUrl);if(!(popupWindow==null||(_popupWindow=popupWindow)!=null&&_popupWindow.closed)){_context3.next=16;break;}features=getPopupFeaturesString(openOptions==null?void 0:openOptions.windowFeatures);popupWindow=window.open(url,openOptions==null?void 0:openOptions.windowName,features);if(!popupWindow){_context3.next=15;break;}try{popupWindow.focus();}catch(e){}_context3.next=16;break;case 15:throw new CodedError('ERR_WEB_BROWSER_BLOCKED','Popup window was blocked by the browser or failed to open. This can happen in mobile browsers when the window.open() method was invoked too long after a user input was fired.');case 16:return _context3.abrupt(\"return\",new Promise(function _callee(resolve){var listener,appStateListener,interval;return _regeneratorRuntime.async(function _callee$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:listener=function listener(event){if(!event.isTrusted)return;if(event.origin!==window.location.origin){return;}var data=event.data;var handle=window.localStorage.getItem(getHandle());if(data.expoSender===handle){dismissPopup();resolve({type:'success',url:data.url});}};window.addEventListener('message',listener,false);appStateListener=function appStateListener(state){if(state!=='active'){return;}var handle=window.localStorage.getItem(getHandle());if(handle){var _url=window.localStorage.getItem(getOriginUrlHandle(handle));if(_url){dismissPopup();resolve({type:'success',url:_url});}}};AppState.addEventListener('change',appStateListener);interval=setInterval(function(){var _popupWindow2;if((_popupWindow2=popupWindow)!=null&&_popupWindow2.closed){if(resolve)resolve({type:WebBrowserResultType.DISMISS});clearInterval(interval);dismissPopup();}},1000);listenerMap.set(popupWindow,{listener:listener,interval:interval,appStateListener:appStateListener});case 6:case\"end\":return _context2.stop();}}},null,null,null,Promise);}));case 17:case\"end\":return _context3.stop();}}},null,null,null,Promise);}};function isCryptoAvailable(){var _window;if(!Platform.isDOMAvailable)return false;return!!((_window=window)!=null&&_window.crypto);}function isSubtleCryptoAvailable(){if(!isCryptoAvailable())return false;return!!window.crypto.subtle;}function getStateFromUrlOrGenerateAsync(inputUrl){var url;return _regeneratorRuntime.async(function getStateFromUrlOrGenerateAsync$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:url=new URL(inputUrl);if(!(url.searchParams.has('state')&&typeof url.searchParams.get('state')==='string')){_context4.next=3;break;}return _context4.abrupt(\"return\",url.searchParams.get('state'));case 3:_context4.next=5;return _regeneratorRuntime.awrap(generateStateAsync());case 5:return _context4.abrupt(\"return\",_context4.sent);case 6:case\"end\":return _context4.stop();}}},null,null,null,Promise);}function getRedirectUrlFromUrlOrGenerate(inputUrl){var url=new URL(inputUrl);if(url.searchParams.has('redirect_uri')&&typeof url.searchParams.get('redirect_uri')==='string'){return url.searchParams.get('redirect_uri');}return location.origin+location.pathname;}var CHARSET='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';function generateStateAsync(){var encoder,data,buffer,hashedData,state;return _regeneratorRuntime.async(function generateStateAsync$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(isSubtleCryptoAvailable()){_context5.next=2;break;}throw new CodedError('ERR_WEB_BROWSER_CRYPTO',\"The current environment doesn't support crypto. Ensure you are running from a secure origin (https).\");case 2:encoder=new TextEncoder();data=generateRandom(10);buffer=encoder.encode(data);_context5.next=7;return _regeneratorRuntime.awrap(crypto.subtle.digest('SHA-256',buffer));case 7:hashedData=_context5.sent;state=btoa(String.fromCharCode.apply(String,_toConsumableArray(new Uint8Array(hashedData))));return _context5.abrupt(\"return\",state);case 10:case\"end\":return _context5.stop();}}},null,null,null,Promise);}function generateRandom(size){var arr=new Uint8Array(size);if(arr.byteLength!==arr.length){arr=new Uint8Array(arr.buffer);}var array=new Uint8Array(arr.length);if(isCryptoAvailable()){window.crypto.getRandomValues(array);}else{for(var i=0;i<size;i+=1){array[i]=Math.random()*CHARSET.length|0;}}return bufferToString(array);}function bufferToString(buffer){var state=[];for(var i=0;i<buffer.byteLength;i+=1){var index=buffer[i]%CHARSET.length;state.push(CHARSET[index]);}return state.join('');}function normalizePopupFeaturesString(options){var windowFeatures={};if(typeof options==='string'){var windowFeaturePairs=options.split(',');for(var _iterator=_createForOfIteratorHelperLoose(windowFeaturePairs),_step;!(_step=_iterator()).done;){var pair=_step.value;var _pair$trim$split=pair.trim().split('='),_pair$trim$split2=_slicedToArray(_pair$trim$split,2),key=_pair$trim$split2[0],value=_pair$trim$split2[1];if(key&&value){windowFeaturePairs[key]=value;}}}else if(options){windowFeatures=options;}return windowFeatures;}function getPopupFeaturesString(options){var _windowFeatures$width,_windowFeatures$heigh,_windowFeatures$top,_windowFeatures$left,_windowFeatures$toolb,_windowFeatures$menub,_windowFeatures$locat,_windowFeatures$resiz,_windowFeatures$statu,_windowFeatures$scrol;var windowFeatures=normalizePopupFeaturesString(options);var width=(_windowFeatures$width=windowFeatures.width)!=null?_windowFeatures$width:POPUP_WIDTH;var height=(_windowFeatures$heigh=windowFeatures.height)!=null?_windowFeatures$heigh:POPUP_HEIGHT;var dimensions=Dimensions.get('screen');var top=(_windowFeatures$top=windowFeatures.top)!=null?_windowFeatures$top:Math.max(0,(dimensions.height-height)*0.5);var left=(_windowFeatures$left=windowFeatures.left)!=null?_windowFeatures$left:Math.max(0,(dimensions.width-width)*0.5);return featureObjectToString(_objectSpread(_objectSpread({},windowFeatures),{},{toolbar:(_windowFeatures$toolb=windowFeatures.toolbar)!=null?_windowFeatures$toolb:'no',menubar:(_windowFeatures$menub=windowFeatures.menubar)!=null?_windowFeatures$menub:'no',location:(_windowFeatures$locat=windowFeatures.location)!=null?_windowFeatures$locat:'yes',resizable:(_windowFeatures$resiz=windowFeatures.resizable)!=null?_windowFeatures$resiz:'yes',status:(_windowFeatures$statu=windowFeatures.status)!=null?_windowFeatures$statu:'no',scrollbars:(_windowFeatures$scrol=windowFeatures.scrollbars)!=null?_windowFeatures$scrol:'yes',top:top,left:left,width:width,height:height}));}export function featureObjectToString(features){return Object.keys(features).reduce(function(prev,current){var value=features[current];if(typeof value==='boolean'){value=value?'yes':'no';}if(current&&value){if(prev)prev+=',';return\"\"+prev+current+\"=\"+value;}return prev;},'');}","map":{"version":3,"sources":["../src/ExpoWebBrowser.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { CodedError, Platform } from '@unimodules/core';\nimport compareUrls from 'compare-urls';\nimport { AppState, Dimensions, AppStateStatus } from 'react-native';\n\nimport {\n  WebBrowserAuthSessionResult,\n  WebBrowserOpenOptions,\n  WebBrowserResult,\n  WebBrowserResultType,\n  WebBrowserWindowFeatures,\n} from './WebBrowser.types';\n\nconst POPUP_WIDTH = 500;\nconst POPUP_HEIGHT = 650;\n\nlet popupWindow: Window | null = null;\n\nconst listenerMap = new Map();\n\nconst getHandle = () => 'ExpoWebBrowserRedirectHandle';\nconst getOriginUrlHandle = (hash: string) => `ExpoWebBrowser_OriginUrl_${hash}`;\nconst getRedirectUrlHandle = (hash: string) => `ExpoWebBrowser_RedirectUrl_${hash}`;\n\nfunction dismissPopup() {\n  if (!popupWindow) {\n    return;\n  }\n  popupWindow.close();\n  if (listenerMap.has(popupWindow)) {\n    const { listener, appStateListener, interval } = listenerMap.get(popupWindow);\n    clearInterval(interval);\n    window.removeEventListener('message', listener);\n    AppState.removeEventListener('change', appStateListener);\n    listenerMap.delete(popupWindow);\n\n    const handle = window.localStorage.getItem(getHandle());\n    if (handle) {\n      window.localStorage.removeItem(getHandle());\n      window.localStorage.removeItem(getOriginUrlHandle(handle));\n      window.localStorage.removeItem(getRedirectUrlHandle(handle));\n    }\n\n    popupWindow = null;\n  }\n}\n\nexport default {\n  get name() {\n    return 'ExpoWebBrowser';\n  },\n  async openBrowserAsync(\n    url: string,\n    browserParams: WebBrowserOpenOptions = {}\n  ): Promise<WebBrowserResult> {\n    if (!Platform.isDOMAvailable) return { type: WebBrowserResultType.CANCEL };\n    const { windowName = '_blank', windowFeatures } = browserParams;\n    const features = getPopupFeaturesString(windowFeatures);\n    window.open(url, windowName, features);\n    return { type: WebBrowserResultType.OPENED };\n  },\n  dismissAuthSession() {\n    if (!Platform.isDOMAvailable) return;\n    dismissPopup();\n  },\n  maybeCompleteAuthSession({\n    skipRedirectCheck,\n  }: {\n    skipRedirectCheck?: boolean;\n  }): { type: 'success' | 'failed'; message: string } {\n    if (!Platform.isDOMAvailable) {\n      return {\n        type: 'failed',\n        message: 'Cannot use expo-web-browser in a non-browser environment',\n      };\n    }\n    const handle = window.localStorage.getItem(getHandle());\n\n    if (!handle) {\n      return { type: 'failed', message: 'No auth session is currently in progress' };\n    }\n\n    const url = window.location.href;\n\n    if (skipRedirectCheck !== true) {\n      const redirectUrl = window.localStorage.getItem(getRedirectUrlHandle(handle));\n      // Compare the original redirect url against the current url with it's query params removed.\n      const currentUrl = window.location.origin + window.location.pathname;\n      if (!compareUrls(redirectUrl, currentUrl)) {\n        return {\n          type: 'failed',\n          message: `Current URL \"${currentUrl}\" and original redirect URL \"${redirectUrl}\" do not match.`,\n        };\n      }\n    }\n\n    // Save the link for app state listener\n    window.localStorage.setItem(getOriginUrlHandle(handle), url);\n\n    // Get the window that created the current popup\n    const parent = window.opener ?? window.parent;\n    if (!parent) {\n      throw new CodedError(\n        'ERR_WEB_BROWSER_REDIRECT',\n        `The window cannot complete the redirect request because the invoking window doesn't have a reference to it's parent. This can happen if the parent window was reloaded.`\n      );\n    }\n    // Send the URL back to the opening window.\n    parent.postMessage({ url, expoSender: handle }, parent.location);\n    return { type: 'success', message: `Attempting to complete auth` };\n\n    // Maybe set timer to throw an error if the window is still open after attempting to complete.\n  },\n  // This method should be invoked from user input.\n  async openAuthSessionAsync(\n    url: string,\n    redirectUrl?: string,\n    openOptions?: WebBrowserOpenOptions\n  ): Promise<WebBrowserAuthSessionResult> {\n    if (!Platform.isDOMAvailable) return { type: WebBrowserResultType.CANCEL };\n\n    redirectUrl = redirectUrl ?? getRedirectUrlFromUrlOrGenerate(url);\n\n    const state = await getStateFromUrlOrGenerateAsync(url);\n\n    // Save handle for session\n    window.localStorage.setItem(getHandle(), state);\n    // Save redirect Url for further verification\n    window.localStorage.setItem(getRedirectUrlHandle(state), redirectUrl);\n\n    if (popupWindow == null || popupWindow?.closed) {\n      const features = getPopupFeaturesString(openOptions?.windowFeatures);\n      popupWindow = window.open(url, openOptions?.windowName, features);\n\n      if (popupWindow) {\n        try {\n          popupWindow.focus();\n        } catch (e) {}\n      } else {\n        throw new CodedError(\n          'ERR_WEB_BROWSER_BLOCKED',\n          'Popup window was blocked by the browser or failed to open. This can happen in mobile browsers when the window.open() method was invoked too long after a user input was fired.'\n        );\n      }\n    }\n\n    return new Promise(async resolve => {\n      // Create a listener for messages sent from the popup\n      const listener = (event: MessageEvent) => {\n        if (!event.isTrusted) return;\n        // Ensure we trust the sender.\n        if (event.origin !== window.location.origin) {\n          return;\n        }\n        const { data } = event;\n        // Use a crypto hash to invalid message.\n        const handle = window.localStorage.getItem(getHandle());\n        // Ensure the sender is also from expo-web-browser\n        if (data.expoSender === handle) {\n          dismissPopup();\n          resolve({ type: 'success', url: data.url });\n        }\n      };\n\n      // Add a listener for receiving messages from the popup.\n      window.addEventListener('message', listener, false);\n\n      // Create an app state listener as a fallback to the popup listener\n      const appStateListener = (state: AppStateStatus) => {\n        if (state !== 'active') {\n          return;\n        }\n        const handle = window.localStorage.getItem(getHandle());\n        if (handle) {\n          const url = window.localStorage.getItem(getOriginUrlHandle(handle));\n          if (url) {\n            dismissPopup();\n            resolve({ type: 'success', url });\n          }\n        }\n      };\n\n      AppState.addEventListener('change', appStateListener);\n\n      // Check if the window has been closed every second.\n      const interval = setInterval(() => {\n        if (popupWindow?.closed) {\n          if (resolve) resolve({ type: WebBrowserResultType.DISMISS });\n          clearInterval(interval);\n          dismissPopup();\n        }\n      }, 1000);\n\n      // Store the listener and interval for clean up.\n      listenerMap.set(popupWindow, {\n        listener,\n        interval,\n        appStateListener,\n      });\n    });\n  },\n};\n\n// Crypto\nfunction isCryptoAvailable(): boolean {\n  if (!Platform.isDOMAvailable) return false;\n  return !!(window?.crypto as any);\n}\n\nfunction isSubtleCryptoAvailable(): boolean {\n  if (!isCryptoAvailable()) return false;\n  return !!(window.crypto.subtle as any);\n}\n\nasync function getStateFromUrlOrGenerateAsync(inputUrl: string): Promise<string> {\n  const url = new URL(inputUrl);\n  if (url.searchParams.has('state') && typeof url.searchParams.get('state') === 'string') {\n    // Ensure we reuse the auth state if it's passed in.\n    return url.searchParams.get('state')!;\n  }\n  // Generate a crypto state for verifying the return popup.\n  return await generateStateAsync();\n}\n\nfunction getRedirectUrlFromUrlOrGenerate(inputUrl: string): string {\n  const url = new URL(inputUrl);\n  if (\n    url.searchParams.has('redirect_uri') &&\n    typeof url.searchParams.get('redirect_uri') === 'string'\n  ) {\n    // Ensure we reuse the redirect_uri if it's passed in the input url.\n    return url.searchParams.get('redirect_uri')!;\n  }\n  // Emulate how native uses Constants.linkingUrl\n  return location.origin + location.pathname;\n}\n\nconst CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n\nasync function generateStateAsync(): Promise<string> {\n  if (!isSubtleCryptoAvailable()) {\n    throw new CodedError(\n      'ERR_WEB_BROWSER_CRYPTO',\n      `The current environment doesn't support crypto. Ensure you are running from a secure origin (https).`\n    );\n  }\n  const encoder = new TextEncoder();\n\n  const data = generateRandom(10);\n  const buffer = encoder.encode(data);\n  const hashedData = await crypto.subtle.digest('SHA-256', buffer);\n  const state = btoa(String.fromCharCode(...new Uint8Array(hashedData)));\n  return state;\n}\n\nfunction generateRandom(size: number): string {\n  let arr = new Uint8Array(size);\n  if (arr.byteLength !== arr.length) {\n    arr = new Uint8Array(arr.buffer);\n  }\n  const array = new Uint8Array(arr.length);\n  if (isCryptoAvailable()) {\n    window.crypto.getRandomValues(array);\n  } else {\n    for (let i = 0; i < size; i += 1) {\n      array[i] = (Math.random() * CHARSET.length) | 0;\n    }\n  }\n  return bufferToString(array);\n}\n\nfunction bufferToString(buffer): string {\n  const state: string[] = [];\n  for (let i = 0; i < buffer.byteLength; i += 1) {\n    const index = buffer[i] % CHARSET.length;\n    state.push(CHARSET[index]);\n  }\n  return state.join('');\n}\n\n// Window Features\n\n// Ensure feature string is an object\nfunction normalizePopupFeaturesString(\n  options?: WebBrowserWindowFeatures | string\n): Record<string, any> {\n  let windowFeatures: Record<string, any> = {};\n  // This should be avoided because it adds extra time to the popup command.\n  if (typeof options === 'string') {\n    // Convert string of `key=value,foo=bar` into an object\n    const windowFeaturePairs = options.split(',');\n    for (const pair of windowFeaturePairs) {\n      const [key, value] = pair.trim().split('=');\n      if (key && value) {\n        windowFeaturePairs[key] = value;\n      }\n    }\n  } else if (options) {\n    windowFeatures = options;\n  }\n  return windowFeatures;\n}\n\n// Apply default values to the input feature set\nfunction getPopupFeaturesString(options?: WebBrowserWindowFeatures | string): string {\n  const windowFeatures = normalizePopupFeaturesString(options);\n\n  const width = windowFeatures.width ?? POPUP_WIDTH;\n  const height = windowFeatures.height ?? POPUP_HEIGHT;\n\n  const dimensions = Dimensions.get('screen');\n  const top = windowFeatures.top ?? Math.max(0, (dimensions.height - height) * 0.5);\n  const left = windowFeatures.left ?? Math.max(0, (dimensions.width - width) * 0.5);\n\n  // Create a reasonable popup\n  // https://developer.mozilla.org/en-US/docs/Web/API/Window/open#Window_features\n  return featureObjectToString({\n    ...windowFeatures,\n    // Toolbar buttons (Back, Forward, Reload, Stop buttons).\n    toolbar: windowFeatures.toolbar ?? 'no',\n    menubar: windowFeatures.menubar ?? 'no',\n    // Shows the location bar or the address bar.\n    location: windowFeatures.location ?? 'yes',\n    resizable: windowFeatures.resizable ?? 'yes',\n    // If this feature is on, then the new secondary window has a status bar.\n    status: windowFeatures.status ?? 'no',\n    scrollbars: windowFeatures.scrollbars ?? 'yes',\n    top,\n    left,\n    width,\n    height,\n  });\n}\n\nexport function featureObjectToString(features: Record<string, any>): string {\n  return Object.keys(features).reduce<string>((prev, current) => {\n    let value = features[current];\n    if (typeof value === 'boolean') {\n      value = value ? 'yes' : 'no';\n    }\n    if (current && value) {\n      if (prev) prev += ',';\n      return `${prev}${current}=${value}`;\n    }\n    return prev;\n  }, '');\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}